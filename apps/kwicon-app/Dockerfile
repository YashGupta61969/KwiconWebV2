FROM node:16 AS app
WORKDIR /app
COPY . .
RUN npm i -g nx
RUN npm install -g pnpm
RUN pnpm install

ARG API_URL
ARG IMAGE_SAS_TOKEN
ARG APP_AUTH0_DOMAIN
ARG APP_AUTH0_CLIENT_ID
ARG APP_URL
ARG WEBSITE_URL
ARG QB_APP_ID
ARG QB_AUTH_KEY
ARG QB_AUTH_SECRET
ARG QB_ACCOUNT_KEY
ARG COMMUNICATION_SERVICES_ENDPOINT

ENV VITE_API_URL=$API_URL
ENV VITE_IMAGE_SAS_TOKEN=$IMAGE_SAS_TOKEN
ENV VITE_APP_AUTH0_DOMAIN=$APP_AUTH0_DOMAIN
ENV VITE_APP_AUTH0_CLIENT_ID=$APP_AUTH0_CLIENT_ID
ENV VITE_APP_URL=$APP_URL
ENV VITE_WEBSITE_URL=$WEBSITE_URL
ENV VITE_QB_APP_ID=$QB_APP_ID
ENV VITE_QB_AUTH_KEY=$QB_AUTH_KEY
ENV VITE_QB_AUTH_SECRET=$QB_AUTH_SECRET
ENV VITE_QB_ACCOUNT_KEY=$QB_ACCOUNT_KEY
ENV VITE_COMMUNICATION_SERVICES_ENDPOINT=$COMMUNICATION_SERVICES_ENDPOINT

RUN nx run kwicon-app:build

FROM nginx AS server

WORKDIR /usr/share/nginx/html

COPY --from=app /app/dist/apps/kwicon-app ./
COPY --from=app /app/apps/kwicon-app/nginx.conf /etc/nginx/nginx.conf
